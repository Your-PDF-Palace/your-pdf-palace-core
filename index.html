<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>YourPDFPalace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>
        .view { display: none; }
        .view.active { display: flex; flex-direction: column; }
        .dashed-border { border: 3px dashed #137fec; border-radius: 16px; transition: all 0.2s; }
        .dashed-border:hover { background-color: #f0f7ff; border-color: #0056b3; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <header class="bg-slate-900 text-white p-4 shadow-2xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <span class="material-icons text-blue-500 text-3xl">fort</span>
                <span class="font-black text-2xl tracking-tighter uppercase">YourPDFPalace</span>
            </div>
            <div class="text-xs font-bold text-slate-400 hidden md:block uppercase tracking-widest">Local & Secure</div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6">
        
        <section id="home-view" class="view active items-center text-center py-12">
            <h1 class="text-6xl font-black text-slate-900 mb-2 uppercase tracking-tight">YOUR PDF PALACE</h1>
            <p class="text-slate-500 mb-12 font-medium text-lg">Fast, Private, and powerful tools that never upload your data.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                <button onclick="initTool('merge')" class="p-8 bg-blue-600 text-white rounded-3xl hover:bg-blue-700 transition-all shadow-xl">
                    <span class="material-icons text-5xl">call_merge</span>
                    <h2 class="text-xl font-bold mt-3">MERGE PDF</h2>
                </button>
                <button onclick="initTool('split')" class="p-8 bg-blue-600 text-white rounded-3xl hover:bg-blue-700 transition-all shadow-xl">
                    <span class="material-icons text-5xl">call_split</span>
                    <h2 class="text-xl font-bold mt-3">SPLIT PDF</h2>
                </button>
                <button onclick="initTool('compress')" class="p-8 bg-indigo-600 text-white rounded-3xl hover:bg-indigo-700 transition-all shadow-xl">
                    <span class="material-icons text-5xl">compress</span>
                    <h2 class="text-xl font-bold mt-3">COMPRESS</h2>
                </button>
                <button onclick="initTool('img2pdf')" class="p-8 bg-slate-800 text-white rounded-3xl hover:bg-slate-900 transition-all shadow-xl">
                    <span class="material-icons text-5xl">image</span>
                    <h2 class="text-xl font-bold mt-3">IMG → PDF</h2>
                </button>
                <button onclick="initTool('pdf2img')" class="p-8 bg-slate-800 text-white rounded-3xl hover:bg-slate-900 transition-all shadow-xl">
                    <span class="material-icons text-5xl">photo_library</span>
                    <h2 class="text-xl font-bold mt-3">PDF → IMG</h2>
                </button>
                <button onclick="initTool('protect')" class="p-8 bg-red-600 text-white rounded-3xl hover:bg-red-700 transition-all shadow-xl">
                    <span class="material-icons text-5xl">lock</span>
                    <h2 class="text-xl font-bold mt-3">PROTECT</h2>
                </button>
            </div>
        </section>

        <section id="tool-view" class="view">
            <button onclick="window.location.reload()" class="text-blue-600 font-bold mb-6 flex items-center gap-2">
                <span class="material-icons">arrow_back</span> BACK TO PALACE
            </button>
            <h2 id="tool-title" class="text-5xl font-black mb-8 uppercase text-slate-900 tracking-tighter">TOOL</h2>
            
            <div id="drop-zone" class="dashed-border p-20 text-center cursor-pointer bg-white shadow-inner">
                <input type="file" id="file-input" class="hidden" multiple>
                <span class="material-icons text-7xl text-blue-600">file_upload</span>
                <p class="text-2xl font-black text-slate-800 mt-4">SELECT YOUR DOCUMENTS</p>
                <p class="text-slate-400 text-sm mt-2 uppercase font-bold tracking-widest">Browser-based processing</p>
            </div>

            <div id="file-list" class="mt-8 space-y-3"></div>

            <div id="split-options" class="hidden mt-8 p-8 bg-white border-2 rounded-2xl shadow-sm">
                <label class="block font-black text-slate-800 mb-2 uppercase italic text-sm">Target Page Range</label>
                <input id="page-range" type="text" placeholder="Example: 1-3" class="w-full p-4 border-2 rounded-xl focus:border-blue-500 outline-none text-lg">
            </div>

            <div id="password-options" class="hidden mt-8 p-8 bg-white border-2 border-red-100 rounded-2xl shadow-sm">
                <label class="block font-black text-red-600 mb-2 uppercase text-sm">Set Security Password</label>
                <input id="pdf-password" type="password" placeholder="Min. 4 characters" class="w-full p-4 border-2 rounded-xl focus:border-red-500 outline-none text-lg">
            </div>

            <button onclick="runProcess()" class="w-full mt-10 bg-blue-600 text-white font-black py-6 rounded-2xl text-2xl shadow-2xl hover:bg-blue-700 active:scale-[0.98] transition-all uppercase tracking-tight">
                EXECUTE ACTION
            </button>
        </section>

        <section id="status-view" class="view items-center justify-center py-20 text-center">
            <div id="loader">
                <span class="material-icons text-blue-600 text-8xl animate-spin-slow">refresh</span>
                <h2 class="text-3xl font-black mt-6 text-slate-900 uppercase tracking-widest">Crunshing Data...</h2>
                <p class="text-slate-500 mt-2">The Palace is working its magic.</p>
            </div>
            <div id="success" class="hidden w-full max-w-lg">
                <span class="material-icons text-green-500 text-9xl">task_alt</span>
                <h2 class="text-5xl font-black my-6 text-slate-900 uppercase">File Ready!</h2>
                <div id="downloads" class="flex flex-col gap-4"></div>
                <button onclick="window.location.reload()" class="mt-12 text-blue-600 font-black hover:underline uppercase text-sm">Return to Workbench</button>
            </div>
        </section>

    </main>

    <script>
        
        const pdfjs = window['pdfjs-dist/build/pdf'];
        pdfjs.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjs.version}/pdf.worker.min.js`;

        let currentMode = '';
        let files = [];

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            files = Array.from(e.target.files);
            const list = document.getElementById('file-list');
            list.innerHTML = files.map(f => `
                <div class="flex items-center bg-white p-4 border-2 rounded-xl shadow-sm border-slate-100">
                    <span class="material-icons text-blue-500 mr-4">description</span>
                    <span class="font-bold text-slate-700 truncate">${f.name}</span>
                </div>
            `).join('');
        };

        function initTool(mode) {
            currentMode = mode;
            document.getElementById('tool-title').innerText = mode.toUpperCase().replace('2', ' TO ');
            
            
            document.getElementById('split-options').style.display = (mode === 'split') ? 'block' : 'none';
            document.getElementById('password-options').style.display = (mode === 'protect') ? 'block' : 'none';
            
        
            fileInput.accept = (mode === 'img2pdf') ? "image/png, image/jpeg" : "application/pdf";
            
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('tool-view').classList.add('active');
        }

        async function runProcess() {
            if (!files.length) return alert("Please select files first!");
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('status-view').classList.add('active');

            try {
                let outBlob;
                if (currentMode === 'pdf2img') {
                    await handlePdfToImg(files[0]);
                } else if (currentMode === 'compress') {
                    const res = await doCompress(files[0]);
                    addBtn(new Blob([res], {type:'application/pdf'}), 'Compressed_Palace.pdf');
                } else if (currentMode === 'protect') {
                    const pass = document.getElementById('pdf-password').value;
                    if(!pass) throw new Error("Password cannot be empty!");
                    const buf = await files[0].arrayBuffer();
                    const res = await doProtect(buf, pass);
                    addBtn(new Blob([res], {type:'application/pdf'}), 'Protected_Palace.pdf');
                } else {
                    const bufs = await Promise.all(files.map(f => f.arrayBuffer()));
                    let res;
                    if (currentMode === 'merge') res = await doMerge(bufs);
                    if (currentMode === 'split') res = await doSplit(bufs[0], document.getElementById('page-range').value);
                    if (currentMode === 'img2pdf') res = await doImg2Pdf(bufs);
                    addBtn(new Blob([res], {type:'application/pdf'}), 'Palace_Result.pdf');
                }

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('success').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("Palace Error: " + err.message);
                window.location.reload();
            }
        }


        async function doMerge(bufs) {
            const doc = await PDFLib.PDFDocument.create();
            for (const b of bufs) {
                const src = await PDFLib.PDFDocument.load(b);
                const pages = await doc.copyPages(src, src.getPageIndices());
                pages.forEach(p => doc.addPage(p));
            }
            return await doc.save();
        }

        async function doSplit(buf, range) {
            const src = await PDFLib.PDFDocument.load(buf);
            const doc = await PDFLib.PDFDocument.create();
            const [s, e] = range.split('-').map(n => parseInt(n) - 1);
            const indices = [];
            for (let i = s; i <= (e || s); i++) if(i < src.getPageCount()) indices.push(i);
            const pages = await doc.copyPages(src, indices);
            pages.forEach(p => doc.addPage(p));
            return await doc.save();
        }

        async function doImg2Pdf(bufs) {
            const doc = await PDFLib.PDFDocument.create();
            for (const b of bufs) {
                const u8 = new Uint8Array(b);
                const img = (u8[0] === 0x89) ? await doc.embedPng(b) : await doc.embedJpg(b);
                const p = doc.addPage([img.width, img.height]);
                p.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
            }
            return await doc.save();
        }

        async function doCompress(file) {
            const data = new Uint8Array(await file.arrayBuffer());
            const pdf = await pdfjs.getDocument({data}).promise;
            const doc = await PDFLib.PDFDocument.create();
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({scale: 1.5});
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({canvasContext: ctx, viewport}).promise;
                const imgData = canvas.toDataURL('image/jpeg', 0.6); // 60% quality
                const img = await doc.embedJpg(imgData);
                const p = doc.addPage([img.width, img.height]);
                p.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
            }
            return await doc.save();
        }

        async function doProtect(buffer, password) {
            const doc = await PDFLib.PDFDocument.load(buffer);
            return await doc.save({
                userPassword: password,
                ownerPassword: password,
                permissions: { printing: 'highResolution', modifying: false, copying: false }
            });
        }

        async function handlePdfToImg(file) {
            const data = new Uint8Array(await file.arrayBuffer());
            const pdf = await pdfjs.getDocument({data}).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({scale: 2.0});
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({canvasContext: ctx, viewport}).promise;
                canvas.toBlob(b => addBtn(b, `Palace_Page_${i}.png`), 'image/png');
            }
        }

        function addBtn(blob, name) {
            const url = URL.createObjectURL(blob);
            const btn = document.createElement('button');
            btn.className = "bg-blue-600 text-white font-black p-5 rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase flex items-center justify-center gap-3";
            btn.innerHTML = `<span class="material-icons">download</span> DOWNLOAD ${name}`;
            btn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
            };
            document.getElementById('downloads').appendChild(btn);
        }
    </script>
</body>
</html>
